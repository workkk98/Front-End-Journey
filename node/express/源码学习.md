# express


#### ä¸­é—´ä»¶

é¦–å…ˆ æˆ‘ä»¬å¾—å…ˆçœ‹expressæ¨¡å—çš„å…¥å£æ–‡ä»¶

```
// /express/index.js
module.exports = require('./lib/express');

```

è¿™æ®µè¯­å¥ è¯´æ˜ å¼•ç”¨äº†./lib/expressæ–‡ä»¶ å¹¶å¯¼å‡ºè¯¥æ¨¡å—
æ‰€ä»¥æˆ‘ä»¬ç›´æ¥çœ‹ express.jsæ–‡ä»¶
```
exports = module.exports = createApplication;

function createApplication() {
  var app = function(req, res, next) {
    app.handle(req, res, next);
  };

  mixin(app, EventEmitter.prototype, false);
  mixin(app, proto, false);

  // expose the prototype that will get set on requests
  app.request = Object.create(req, {
    app: { configurable: true, enumerable: true, writable: true, value: app }
  })

  // expose the prototype that will get set on responses
  app.response = Object.create(res, {
    app: { configurable: true, enumerable: true, writable: true, value: app }
  })

  app.init();
  return app;
}
```

å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ¨¡å—å°±æ˜¯ å¯¼å‡ºäº†createApplicationå‡½æ•°
æ‰€ä»¥ å½“æ‰§è¡Œexpress() å‡½æ•°æ—¶ç›¸å½“äº æ‰§è¡ŒcreateApplication()å‡½æ•°
mixinæ˜¯ä¸ªç¬¬ä¸‰æ–¹åº“çš„å‡½æ•°ï¼Œä¸»è¦å°±æ˜¯å°†EventEmitterå¯¹è±¡ å’Œ proto(application)æ··å…¥appä¸­
ç„¶åæš´éœ²äº†ä¸¤ä¸ªå¯¹è±¡ request å’Œ response

**æˆ‘ä»¬ç€é‡æ¥çœ‹protoå¯¹è±¡æœ‰ä»€ä¹ˆæ–¹æ³•å’Œå±æ€§**

åˆšåˆšæœ‰æåˆ°protoæ˜¯applicationå¯¹è±¡
åœ¨åˆ‡æ¢åˆ°/express/lib/application.js

```
// æºäºè¿™ä¸€è¡Œ
var proto = require('./application');

app.use = function use(fn) {
  var offset = 0;
  var path = '/';

  // default path to '/'
  // disambiguate app.use([fn])
  if (typeof fn !== 'function') {
    var arg = fn;

    while (Array.isArray(arg) && arg.length !== 0) {
      arg = arg[0];
    }

    // first arg is the path
    if (typeof arg !== 'function') {
      offset = 1;
      path = fn;
    }
  }
  // æ‰å¹³åŒ–argumentsä¸­çš„æ•°ç»„
  var fns = flatten(slice.call(arguments, offset));

  if (fns.length === 0) {
    throw new TypeError('app.use() requires a middleware function')
  }

  // setup router
  this.lazyrouter();
  var router = this._router;

  fns.forEach(function (fn) {
    // non-express app
    if (!fn || !fn.handle || !fn.set) {
      return router.use(path, fn);
    }

    debug('.use app under %s', path);
    fn.mountpath = path;
    fn.parent = this;

    // restore .app property on req and res
    router.use(path, function mounted_app(req, res, next) {
      var orig = req.app;
      fn.handle(req, res, function (err) {
        setPrototypeOf(req, orig.request)
        setPrototypeOf(res, orig.response)
        next(err);
      });
    });

    // mounted an app
    fn.emit('mount', this);
  }, this);

  return this;
};

```

app.use() å†ç†Ÿæ‚‰ä¸è¿‡ æ³¨å†Œä¸­é—´ä»¶çš„ç”¨æ³•
å®ƒä¸»è¦å…ˆæ•´ç†äº†å‚æ•°ï¼Œä¸ºäº†é€‚åº”å¤šç§å†™æ³• åˆ¤æ–­ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¦æ˜¯è·¯å¾„ ï¼Œå†æ‰å¹³åŒ– fnæ•°ç»„
æ•´ç†å®Œå
æ‰§è¡Œäº†
> fns.forEach(function (fn) {

  },this)
è¿™é‡Œè¯´æ˜ä¸‹ .forEach(callback , thisArg) callbackçš„thisæŒ‡å‘thisArgå‚æ•°
å› ä¸ºæˆ‘ä»¬fn.handleä¸å­˜åœ¨ æ‰€ä»¥è°ƒç”¨äº†router.use(path,fn)
/express/router/index

```
proto.use = function use(fn) {
  var offset = 0;
  var path = '/';

  // default path to '/'
  // disambiguate router.use([fn])
  if (typeof fn !== 'function') {
    var arg = fn;

    while (Array.isArray(arg) && arg.length !== 0) {
      arg = arg[0];
    }

    // first arg is the path
    if (typeof arg !== 'function') {
      offset = 1;
      path = fn;
    }
  }

  var callbacks = flatten(slice.call(arguments, offset));

  if (callbacks.length === 0) {
    throw new TypeError('Router.use() requires a middleware function')
  }

  for (var i = 0; i < callbacks.length; i++) {
    var fn = callbacks[i];

    if (typeof fn !== 'function') {
      throw new TypeError('Router.use() requires a middleware function but got a ' + gettype(fn))
    }

    // add the middleware
    debug('use %o %s', path, fn.name || '<anonymous>')

    var layer = new Layer(path, {
      sensitive: this.caseSensitive,
      strict: false,
      end: false
    }, fn);

    layer.route = undefined;

    this.stack.push(layer);
  }

  return this;
};
```

router.use() å‡½æ•°ä»ç„¶åœ¨å¼€å¤´æ•´ç†äº†å‚æ•°

æ³¨æ„åœ¨è¿™é‡Œ **var layer = new Layer()** æ¯ä¸ªpath å’Œ å¯¹åº”çš„fn éƒ½åˆ›å»ºäº†ä¸€ä¸ª layerå¯¹è±¡
å¹¶å‹å…¥äº†this.stacä¸­

æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä»è¿™ç®€å•ç†è§£expressçš„ä¸­é—´ä»¶å½¢å¼
å°±æ˜¯ appå†…éƒ¨ æœ‰ä¸€ä¸ªstackæ ˆ å­˜æ”¾äº†ä¸­é—´ä»¶ æ¯ä¸ªä¸­é—´ä»¶éƒ½æ˜¯layerçš„å½¢å¼ ç„¶åå½“è¯·æ±‚è§¦å‘æ—¶ æ‰§è¡Œè¿™ä¸ªä¸­é—´å±‚ã€‚

é‚£handleçš„è¿‡ç¨‹è¿˜éœ€è¦åé¢åœ¨çœ‹ğŸ’ƒ
